name: Run Shipping Details Services on AWS EC2

on:
  workflow_dispatch:  # Allows manual execution from GitHub Actions UI

jobs:
  deploy:
    name: Deploy Services on AWS EC2
    runs-on: ubuntu-latest
    steps:

      - name: Executing remote SSH on EC2 for Kafka & Zookeeper
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_SD_BROKER }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Pulling latest Kafka and Zookeeper images..."
            sudo docker pull confluentinc/cp-zookeeper:latest
            sudo docker pull confluentinc/cp-kafka:latest

            echo "Stopping and removing existing Kafka & Zookeeper containers..."
            sudo docker stop zookeeper kafka || echo "No existing containers"
            sudo docker rm zookeeper kafka || echo "No existing containers"

            echo "Creating app-network if not exists..."
            sudo docker network create app-network || echo "Network already exists"

            echo "Starting Zookeeper container..."
            sudo docker run -d --name zookeeper \
              --network app-network \
              -p 2181:2181 \
              -e ZOOKEEPER_CLIENT_PORT=2181 \
              -e ZOOKEEPER_TICK_TIME=2000 \
              --restart unless-stopped \
              confluentinc/cp-zookeeper:latest

            echo "Starting Kafka container..."
            sudo docker run -d --name kafka \
              --network app-network \
              --depends-on zookeeper \
              -p 9092:9092 -p 29092:29092 \
              -e KAFKA_BROKER_ID=1 \
              -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
              -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092 \
              -e KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT \
              -e KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT \
              -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
              --restart unless-stopped \
              confluentinc/cp-kafka:latest

      - name: Deploy to EC2 - Shipping Details Replicant
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_SD_REPLICANT }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Pulling latest image for Shipping Details Replicant..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/shipping-details-replicant:latest

            echo "Stopping and removing existing container..."
            sudo docker stop shipping_details_replicant || echo "No existing container"
            sudo docker rm shipping_details_replicant || echo "No existing container"

            echo "Starting Shipping Details Replicant container..."
            sudo docker run -d --name shipping_details_replicant \
              -p 80:80 \
              -e GIN_MODE=release \
              -e shipping_details_BROKER=${{ secrets.SD_BROKER }} \
              --network app-network \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/shipping-details-replicant:latest

      - name: Deploy to EC2 - Create Shipping Details (With MongoDB)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_SD_CREATE }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Pulling latest images for Create Shipping Details..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/create-shipping-details:latest

            echo "Stopping and removing existing containers..."
            sudo docker stop shipping_details-db create_shipping_details || echo "No existing containers"
            sudo docker rm shipping_details-db create_shipping_details || echo "No existing containers"

            echo "Starting MongoDB container..."
            sudo docker run -d --name shipping_details-db \
              -p 27017:27017 \
              -e MONGO_INITDB_ROOT_USERNAME=${{ secrets.SD_DB_USER }} \
              -e MONGO_INITDB_ROOT_PASSWORD=${{ secrets.SD_DB_PWD }} \
              --network app-network \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest

            echo "Starting Create Shipping Details container..."
            sudo docker run -d --name create_shipping_details \
              -p 80:80 \
              -e GIN_MODE=release \
              -e shipping_details_URI=mongodb://${{ secrets.SD_DB_USER }}:${{ secrets.SD_DB_PWD }}@shipping_details-db:27017 \
              -e shipping_details_BROKER=${{ secrets.SD_BROKER }} \
              --network app-network \
              --restart unless-stopped \
              --depends-on shipping_details-db \
              ${{ secrets.DOCKER_USERNAME }}/create-shipping-details:latest

      - name: Deploy to EC2 - Delete Shipping Details (With MongoDB)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_SD_DELETE }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Pulling latest images for Delete Shipping Details..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/delete-shipping-details:latest

            echo "Stopping and removing existing containers..."
            sudo docker stop shipping_details-db delete_shipping_details || echo "No existing containers"
            sudo docker rm shipping_details-db delete_shipping_details || echo "No existing containers"

            echo "Starting MongoDB container..."
            sudo docker run -d --name shipping_details-db \
              -p 27017:27017 \
              -e MONGO_INITDB_ROOT_USERNAME=${{ secrets.SD_DB_USER }} \
              -e MONGO_INITDB_ROOT_PASSWORD=${{ secrets.SD_DB_PWD }} \
              --network app-network \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest

            echo "Starting Delete Shipping Details container..."
            sudo docker run -d --name delete_shipping_details \
              -p 80:80 \
              -e GIN_MODE=release \
              -e shipping_details_URI=mongodb://${{ secrets.SD_DB_USER }}:${{ secrets.SD_DB_PWD }}@shipping_details-db:27017 \
              -e shipping_details_BROKER=${{ secrets.SD_BROKER }} \
              --network app-network \
              --restart unless-stopped \
              --depends-on shipping_details-db \
              ${{ secrets.DOCKER_USERNAME }}/delete-shipping-details:latest

      - name: Deploy to EC2 - Get Shipping Details By ID (With MongoDB)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_SD_GET_BY_ID }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Pulling latest images for Get Shipping Details By ID..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/get-shipping-details-by-id:latest

            echo "Stopping and removing existing containers..."
            sudo docker stop shipping_details-db get_shipping_details_by_id || echo "No existing containers"
            sudo docker rm shipping_details-db get_shipping_details_by_id || echo "No existing containers"

            echo "Starting MongoDB container..."
            sudo docker run -d --name shipping_details-db \
              -p 27017:27017 \
              -e MONGO_INITDB_ROOT_USERNAME=${{ secrets.SD_DB_USER }} \
              -e MONGO_INITDB_ROOT_PASSWORD=${{ secrets.SD_DB_PWD }} \
              --network app-network \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest

            echo "Starting Get Shipping Details By ID container..."
            sudo docker run -d --name get_shipping_details_by_id \
              -p 80:80 \
              -e GIN_MODE=release \
              -e shipping_details_URI=mongodb://${{ secrets.SD_DB_USER }}:${{ secrets.SD_DB_PWD }}@shipping_details-db:27017 \
              -e shipping_details_BROKER=${{ secrets.SD_BROKER }} \
              --network app-network \
              --restart unless-stopped \
              --depends-on shipping_details-db \
              ${{ secrets.DOCKER_USERNAME }}/get-shipping-details-by-id:latest



      - name: Deploy to EC2 - UPDATE Shipping Details (With MongoDB)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_SD_UPDATE }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Pulling latest images for update Shipping Details..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/update-shipping-details:latest

            echo "Stopping and removing existing containers..."
            sudo docker stop shipping_details-db update_shipping_details || echo "No existing containers"
            sudo docker rm shipping_details-db update_shipping_details || echo "No existing containers"

            echo "Starting MongoDB container..."
            sudo docker run -d --name shipping_details-db \
              -p 27017:27017 \
              -e MONGO_INITDB_ROOT_USERNAME=${{ secrets.SD_DB_USER }} \
              -e MONGO_INITDB_ROOT_PASSWORD=${{ secrets.SD_DB_PWD }} \
              --network app-network \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest

            echo "Starting update Shipping Details container..."
            sudo docker run -d --name update_shipping_details \
              -p 80:80 \
              -e GIN_MODE=release \
              -e shipping_details_URI=mongodb://${{ secrets.SD_DB_USER }}:${{ secrets.SD_DB_PWD }}@shipping_details-db:27017 \
              -e shipping_details_BROKER=${{ secrets.SD_BROKER }} \
              --network app-network \
              --restart unless-stopped \
              --depends-on shipping_details-db \
              ${{ secrets.DOCKER_USERNAME }}/update-shipping-details:latest

      - name: Deploy to EC2 - list Shipping Details (With MongoDB)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST_SD_LIST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Pulling latest images for list Shipping Details..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/list-shipping-details:latest

            echo "Stopping and removing existing containers..."
            sudo docker stop shipping_details-db list_shipping_details || echo "No existing containers"
            sudo docker rm shipping_details-db list_shipping_details || echo "No existing containers"

            echo "Starting MongoDB container..."
            sudo docker run -d --name shipping_details-db \
              -p 27017:27017 \
              -e MONGO_INITDB_ROOT_USERNAME=${{ secrets.SD_DB_USER }} \
              -e MONGO_INITDB_ROOT_PASSWORD=${{ secrets.SD_DB_PWD }} \
              --network app-network \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/shipping-details-db:latest

            echo "Starting list Shipping Details container..."
            sudo docker run -d --name list_shipping_details \
              -p 80:80 \
              -e GIN_MODE=release \
              -e shipping_details_URI=mongodb://${{ secrets.SD_DB_USER }}:${{ secrets.SD_DB_PWD }}@shipping_details-db:27017 \
              -e shipping_details_BROKER=${{ secrets.SD_BROKER }} \
              --network app-network \
              --restart unless-stopped \
              --depends-on shipping_details-db \
              ${{ secrets.DOCKER_USERNAME }}/list-shipping-details:latest